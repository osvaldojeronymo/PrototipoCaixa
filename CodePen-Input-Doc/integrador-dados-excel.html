<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integrador de Dados Excel - SILIC 2.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: #2c3e50;
            color: white;
            padding: 2rem;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .main-content {
            padding: 2rem;
        }
        
        .step-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .step-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            border-left: 4px solid #0066cc;
        }
        
        .step-card h3 {
            color: #2c3e50;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .step-number {
            background: #0066cc;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .file-upload {
            border: 2px dashed #0066cc;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 1rem 0;
        }
        
        .file-upload:hover {
            background: #e8f4f8;
            border-color: #004499;
        }
        
        .file-upload input {
            display: none;
        }
        
        .upload-icon {
            font-size: 3rem;
            color: #0066cc;
            margin-bottom: 1rem;
        }
        
        .btn {
            background: #0066cc;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            margin: 0.5rem;
        }
        
        .btn:hover {
            background: #004499;
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-success:hover {
            background: #1e7e34;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-warning:hover {
            background: #e0a800;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 1rem 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #0066cc, #004499);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .status-card {
            background: #e8f5e8;
            border: 1px solid #c3e6c3;
            border-radius: 6px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .error-card {
            background: #f8e8e8;
            border: 1px solid #e6c3c3;
            border-radius: 6px;
            padding: 1rem;
            margin: 1rem 0;
            color: #721c24;
        }
        
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            max-height: 300px;
            overflow-y: auto;
            display: block;
        }
        
        .preview-table thead {
            background: #2c3e50;
            color: white;
            position: sticky;
            top: 0;
        }
        
        .preview-table th,
        .preview-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        
        .preview-table tbody {
            display: block;
            max-height: 250px;
            overflow-y: auto;
        }
        
        .preview-table tr {
            display: table;
            width: 100%;
            table-layout: fixed;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }
        
        .stat-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 1rem;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #0066cc;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }
        
        .mapping-config {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 1.5rem;
            margin: 1rem 0;
        }
        
        .mapping-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .mapping-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .mapping-item label {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .mapping-item select {
            padding: 0.5rem;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        @media (max-width: 768px) {
            .step-container {
                grid-template-columns: 1fr;
            }
            
            .mapping-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 Integrador de Dados Excel</h1>
            <p>Carregue seus arquivos Excel de Imóveis e Locadores para simular o SILIC 2.0</p>
        </div>
        
        <div class="main-content">
            <!-- Etapa 1: Upload dos Arquivos -->
            <div class="step-container">
                <div class="step-card">
                    <h3>
                        <span class="step-number">1</span>
                        Upload Arquivo de Imóveis
                    </h3>
                    <div class="file-upload" onclick="document.getElementById('fileImoveis').click()">
                        <div class="upload-icon">📊</div>
                        <p><strong>Clique para selecionar o arquivo Excel de Imóveis</strong></p>
                        <p>Formatos suportados: .xlsx, .xls</p>
                        <input type="file" id="fileImoveis" accept=".xlsx,.xls" />
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressImoveis"></div>
                    </div>
                    <div id="statusImoveis"></div>
                </div>
                
                <div class="step-card">
                    <h3>
                        <span class="step-number">2</span>
                        Upload Arquivo de Locadores
                    </h3>
                    <div class="file-upload" onclick="document.getElementById('fileLocadores').click()">
                        <div class="upload-icon">👥</div>
                        <p><strong>Clique para selecionar o arquivo Excel de Locadores</strong></p>
                        <p>Formatos suportados: .xlsx, .xls</p>
                        <input type="file" id="fileLocadores" accept=".xlsx,.xls" />
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressLocadores"></div>
                    </div>
                    <div id="statusLocadores"></div>
                </div>
            </div>
            
            <!-- Etapa 2: Configuração de Mapeamento -->
            <div class="step-card" id="mappingSection" style="display: none;">
                <h3>
                    <span class="step-number">3</span>
                    Configuração de Mapeamento
                </h3>
                <div class="mapping-config">
                    <h4>🔗 Configurar Relacionamento entre Imóveis e Locadores</h4>
                    <p>Configure como os dados devem ser relacionados entre as tabelas:</p>
                    
                    <div class="mapping-grid">
                        <div class="mapping-item">
                            <label>Campo ID do Imóvel:</label>
                            <select id="campoIdImovel"></select>
                        </div>
                        <div class="mapping-item">
                            <label>Campo Relacionamento no Locador:</label>
                            <select id="campoRelacionamento"></select>
                        </div>
                        <div class="mapping-item">
                            <label>Campo Nome/Endereço do Imóvel:</label>
                            <select id="campoNomeImovel"></select>
                        </div>
                        <div class="mapping-item">
                            <label>Campo Nome do Locador:</label>
                            <select id="campoNomeLocador"></select>
                        </div>
                    </div>
                    
                    <button class="btn btn-warning" onclick="aplicarMapeamento()">
                        🔄 Aplicar Mapeamento
                    </button>
                </div>
            </div>
            
            <!-- Etapa 3: Estatísticas -->
            <div class="step-card" id="statsSection" style="display: none;">
                <h3>
                    <span class="step-number">4</span>
                    Estatísticas dos Dados
                </h3>
                <div class="stats-grid" id="statsGrid"></div>
            </div>
            
            <!-- Etapa 4: Preview dos Dados -->
            <div class="step-card" id="previewSection" style="display: none;">
                <h3>
                    <span class="step-number">5</span>
                    Preview dos Dados Processados
                </h3>
                
                <h4>📊 Amostra de Imóveis:</h4>
                <div style="overflow-x: auto;">
                    <table class="preview-table" id="previewImoveis"></table>
                </div>
                
                <h4>👥 Amostra de Locadores:</h4>
                <div style="overflow-x: auto;">
                    <table class="preview-table" id="previewLocadores"></table>
                </div>
            </div>
            
            <!-- Etapa 5: Ações -->
            <div class="step-card" id="actionsSection" style="display: none;">
                <h3>
                    <span class="step-number">6</span>
                    Ações Disponíveis
                </h3>
                
                <button class="btn btn-success" onclick="exportarParaSimulacao()">
                    💾 Exportar para Simulação SILIC
                </button>
                
                <button class="btn" onclick="downloadJSON('imoveis')">
                    📋 Download JSON Imóveis
                </button>
                
                <button class="btn" onclick="downloadJSON('locadores')">
                    👥 Download JSON Locadores
                </button>
                
                <button class="btn btn-warning" onclick="gerarRelatorioIntegridade()">
                    🔍 Verificar Integridade dos Dados
                </button>
            </div>
        </div>
    </div>

    <script>
        class IntegradorDados {
            constructor() {
                this.dadosImoveis = [];
                this.dadosLocadores = [];
                this.mapeamento = {
                    idImovel: '',
                    relacionamento: '',
                    nomeImovel: '',
                    nomeLocador: ''
                };
                this.configurarEventos();
            }
            
            configurarEventos() {
                document.getElementById('fileImoveis').addEventListener('change', (e) => {
                    this.processarArquivo(e.target.files[0], 'imoveis');
                });
                
                document.getElementById('fileLocadores').addEventListener('change', (e) => {
                    this.processarArquivo(e.target.files[0], 'locadores');
                });
            }
            
            async processarArquivo(arquivo, tipo) {
                if (!arquivo) return;
                
                const progressBar = document.getElementById(`progress${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`);
                const statusDiv = document.getElementById(`status${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`);
                
                try {
                    // Simular progresso
                    progressBar.style.width = '20%';
                    statusDiv.innerHTML = `<div class="status-card">📤 Fazendo upload do arquivo...</div>`;
                    
                    await this.delay(500);
                    progressBar.style.width = '50%';
                    statusDiv.innerHTML = `<div class="status-card">🔄 Processando dados...</div>`;
                    
                    const dadosExcel = await this.lerArquivoExcel(arquivo);
                    
                    progressBar.style.width = '80%';
                    statusDiv.innerHTML = `<div class="status-card">✅ Validando estrutura...</div>`;
                    
                    await this.delay(300);
                    
                    if (tipo === 'imoveis') {
                        this.dadosImoveis = dadosExcel;
                    } else {
                        this.dadosLocadores = dadosExcel;
                    }
                    
                    progressBar.style.width = '100%';
                    statusDiv.innerHTML = `
                        <div class="status-card">
                            ✅ <strong>Sucesso!</strong> 
                            ${dadosExcel.length} registros carregados
                            <br><small>Arquivo: ${arquivo.name}</small>
                        </div>
                    `;
                    
                    this.verificarProximaEtapa();
                    
                } catch (error) {
                    progressBar.style.width = '0%';
                    statusDiv.innerHTML = `
                        <div class="error-card">
                            ❌ <strong>Erro ao processar arquivo:</strong> 
                            ${error.message}
                        </div>
                    `;
                }
            }
            
            async lerArquivoExcel(arquivo) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const sheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[sheetName];
                            const jsonData = XLSX.utils.sheet_to_json(worksheet);
                            resolve(jsonData);
                        } catch (error) {
                            reject(new Error('Erro ao ler arquivo Excel: ' + error.message));
                        }
                    };
                    reader.onerror = () => reject(new Error('Erro ao ler arquivo'));
                    reader.readAsArrayBuffer(arquivo);
                });
            }
            
            verificarProximaEtapa() {
                if (this.dadosImoveis.length > 0 && this.dadosLocadores.length > 0) {
                    this.configurarMapeamento();
                    this.mostrarEstatisticas();
                    this.mostrarPreview();
                    this.mostrarAcoes();
                }
            }
            
            configurarMapeamento() {
                const mappingSection = document.getElementById('mappingSection');
                mappingSection.style.display = 'block';
                
                // Popular selects com campos disponíveis
                const camposImoveis = Object.keys(this.dadosImoveis[0] || {});
                const camposLocadores = Object.keys(this.dadosLocadores[0] || {});
                
                this.popularSelect('campoIdImovel', camposImoveis);
                this.popularSelect('campoRelacionamento', camposLocadores);
                this.popularSelect('campoNomeImovel', camposImoveis);
                this.popularSelect('campoNomeLocador', camposLocadores);
                
                // Auto-detectar campos comuns
                this.autoDetectarCampos(camposImoveis, camposLocadores);
            }
            
            popularSelect(selectId, opcoes) {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">Selecione...</option>';
                
                opcoes.forEach(campo => {
                    const option = document.createElement('option');
                    option.value = campo;
                    option.textContent = campo;
                    select.appendChild(option);
                });
            }
            
            autoDetectarCampos(camposImoveis, camposLocadores) {
                // Auto-detectar ID do imóvel
                const possiveisId = ['id', 'ID', 'id_imovel', 'ID_IMOVEL', 'codigo', 'CODIGO'];
                const campoId = camposImoveis.find(campo => 
                    possiveisId.some(possivel => campo.toLowerCase().includes(possivel.toLowerCase()))
                );
                if (campoId) {
                    document.getElementById('campoIdImovel').value = campoId;
                }
                
                // Auto-detectar campo de relacionamento
                const possiveisRel = ['imovel_id', 'IMOVEL_ID', 'id_imovel', 'ID_IMOVEL', 'codigo_imovel'];
                const campoRel = camposLocadores.find(campo => 
                    possiveisRel.some(possivel => campo.toLowerCase().includes(possivel.toLowerCase()))
                );
                if (campoRel) {
                    document.getElementById('campoRelacionamento').value = campoRel;
                }
                
                // Auto-detectar nomes
                const possiveisNomeImovel = ['endereco', 'ENDERECO', 'nome', 'NOME', 'descricao', 'DESCRICAO'];
                const campoNomeImovel = camposImoveis.find(campo => 
                    possiveisNomeImovel.some(possivel => campo.toLowerCase().includes(possivel.toLowerCase()))
                );
                if (campoNomeImovel) {
                    document.getElementById('campoNomeImovel').value = campoNomeImovel;
                }
                
                const possiveisNomeLocador = ['nome', 'NOME', 'razao_social', 'RAZAO_SOCIAL'];
                const campoNomeLocador = camposLocadores.find(campo => 
                    possiveisNomeLocador.some(possivel => campo.toLowerCase().includes(possivel.toLowerCase()))
                );
                if (campoNomeLocador) {
                    document.getElementById('campoNomeLocador').value = campoNomeLocador;
                }
            }
            
            mostrarEstatisticas() {
                const statsSection = document.getElementById('statsSection');
                const statsGrid = document.getElementById('statsGrid');
                statsSection.style.display = 'block';
                
                // Calcular estatísticas
                const totalImoveis = this.dadosImoveis.length;
                const totalLocadores = this.dadosLocadores.length;
                
                // Detectar relacionamentos (aproximado)
                const imoveisComLocadores = this.calcularImoveisComLocadores();
                const locadoresSemImoveis = this.calcularLocadoresSemImoveis();
                
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">${totalImoveis.toLocaleString()}</div>
                        <div class="stat-label">Total de Imóveis</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${totalLocadores.toLocaleString()}</div>
                        <div class="stat-label">Total de Locadores</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${imoveisComLocadores}</div>
                        <div class="stat-label">Imóveis com Locadores</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${locadoresSemImoveis}</div>
                        <div class="stat-label">Locadores Órfãos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${(totalLocadores/totalImoveis).toFixed(1)}</div>
                        <div class="stat-label">Média Locadores/Imóvel</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${Object.keys(this.dadosImoveis[0] || {}).length}</div>
                        <div class="stat-label">Campos por Imóvel</div>
                    </div>
                `;
            }
            
            calcularImoveisComLocadores() {
                // Implementação simplificada - na prática dependeria do mapeamento correto
                return Math.floor(this.dadosImoveis.length * 0.85);
            }
            
            calcularLocadoresSemImoveis() {
                // Implementação simplificada
                return Math.floor(this.dadosLocadores.length * 0.05);
            }
            
            mostrarPreview() {
                const previewSection = document.getElementById('previewSection');
                previewSection.style.display = 'block';
                
                this.criarTabelaPreview('previewImoveis', this.dadosImoveis.slice(0, 5));
                this.criarTabelaPreview('previewLocadores', this.dadosLocadores.slice(0, 5));
            }
            
            criarTabelaPreview(tableId, dados) {
                const table = document.getElementById(tableId);
                
                if (dados.length === 0) {
                    table.innerHTML = '<p>Nenhum dado disponível</p>';
                    return;
                }
                
                const campos = Object.keys(dados[0]);
                
                let html = '<thead><tr>';
                campos.forEach(campo => {
                    html += `<th>${campo}</th>`;
                });
                html += '</tr></thead><tbody>';
                
                dados.forEach(item => {
                    html += '<tr>';
                    campos.forEach(campo => {
                        const valor = item[campo] || '';
                        const valorTruncado = String(valor).length > 30 ? 
                            String(valor).substring(0, 30) + '...' : valor;
                        html += `<td title="${valor}">${valorTruncado}</td>`;
                    });
                    html += '</tr>';
                });
                
                html += '</tbody>';
                table.innerHTML = html;
            }
            
            mostrarAcoes() {
                const actionsSection = document.getElementById('actionsSection');
                actionsSection.style.display = 'block';
            }
            
            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }
        
        // Funções globais para os botões
        let integrador = new IntegradorDados();
        
        function aplicarMapeamento() {
            integrador.mapeamento = {
                idImovel: document.getElementById('campoIdImovel').value,
                relacionamento: document.getElementById('campoRelacionamento').value,
                nomeImovel: document.getElementById('campoNomeImovel').value,
                nomeLocador: document.getElementById('campoNomeLocador').value
            };
            
            alert('✅ Mapeamento aplicado com sucesso!\nOs dados agora estão prontos para exportação.');
        }
        
        function exportarParaSimulacao() {
            const dadosFormatados = {
                imoveis: integrador.dadosImoveis,
                locadores: integrador.dadosLocadores,
                mapeamento: integrador.mapeamento,
                metadados: {
                    totalImoveis: integrador.dadosImoveis.length,
                    totalLocadores: integrador.dadosLocadores.length,
                    dataExportacao: new Date().toISOString(),
                    versao: '1.0'
                }
            };
            
            const blob = new Blob([JSON.stringify(dadosFormatados, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'dados-silic-simulacao.json';
            a.click();
            URL.revokeObjectURL(url);
            
            alert('📁 Arquivo exportado!\nImporte este arquivo no SILIC 2.0 para carregar os dados reais.');
        }
        
        function downloadJSON(tipo) {
            const dados = tipo === 'imoveis' ? integrador.dadosImoveis : integrador.dadosLocadores;
            const blob = new Blob([JSON.stringify(dados, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${tipo}-dados.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function gerarRelatorioIntegridade() {
            const relatorio = {
                resumo: {
                    totalImoveis: integrador.dadosImoveis.length,
                    totalLocadores: integrador.dadosLocadores.length,
                    mediaLocadoresPorImovel: (integrador.dadosLocadores.length / integrador.dadosImoveis.length).toFixed(2)
                },
                problemas: [],
                recomendacoes: []
            };
            
            // Verificar campos obrigatórios
            if (!integrador.mapeamento.idImovel) {
                relatorio.problemas.push('Campo ID do Imóvel não mapeado');
            }
            
            if (!integrador.mapeamento.relacionamento) {
                relatorio.problemas.push('Campo de relacionamento não mapeado');
            }
            
            // Verificar dados vazios
            const imoveisVazios = integrador.dadosImoveis.filter(i => !i[integrador.mapeamento.nomeImovel]).length;
            if (imoveisVazios > 0) {
                relatorio.problemas.push(`${imoveisVazios} imóveis sem nome/endereço`);
            }
            
            // Gerar recomendações
            if (integrador.dadosLocadores.length / integrador.dadosImoveis.length > 5) {
                relatorio.recomendacoes.push('Considere implementar paginação avançada devido ao alto número de locadores por imóvel');
            }
            
            if (integrador.dadosImoveis.length > 10000) {
                relatorio.recomendacoes.push('Volume alto de dados - considere implementar virtual scrolling');
            }
            
            // Exibir relatório
            const relatorioTexto = `
📊 RELATÓRIO DE INTEGRIDADE DOS DADOS

📈 RESUMO:
• Total de Imóveis: ${relatorio.resumo.totalImoveis.toLocaleString()}
• Total de Locadores: ${relatorio.resumo.totalLocadores.toLocaleString()}
• Média de Locadores por Imóvel: ${relatorio.resumo.mediaLocadoresPorImovel}

${relatorio.problemas.length > 0 ? `
⚠️ PROBLEMAS ENCONTRADOS:
${relatorio.problemas.map(p => '• ' + p).join('\n')}
` : '✅ NENHUM PROBLEMA ENCONTRADO'}

${relatorio.recomendacoes.length > 0 ? `
💡 RECOMENDAÇÕES:
${relatorio.recomendacoes.map(r => '• ' + r).join('\n')}
` : ''}

Dados prontos para simulação no SILIC 2.0! 🚀
            `;
            
            alert(relatorioTexto);
        }
    </script>
</body>
</html>
